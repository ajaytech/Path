/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/Device'],function(q,D){"use strict";var a={EnumMember:true,Path:true,PropertyPath:true,NavigationPropertyPath:true,AnnotationPath:true};var t={Binary:true,Bool:true,Date:true,DateTimeOffset:true,Decimal:true,Duration:true,Float:true,Guid:true,Int:true,String:true,TimeOfDay:true,LabelElementReference:true,EnumMember:true,Path:true,PropertyPath:true,NavigationPropertyPath:true,AnnotationPath:true};var M={And:true,Or:true,Eq:true,Ne:true,Gt:true,Ge:true,Lt:true,Le:true,If:true,Collection:true};var A={merge:function(T,s){var b,c;var S=["propertyAnnotations","EntityContainer","annotationReferences"];for(b in s){if(S.indexOf(b)!==-1){continue;}A._mergeAnnotation(b,s,T);}for(var i=0;i<S.length;++i){var d=S[i];T[d]=T[d]||{};for(b in s[d]){for(c in s[d][b]){T[d][b]=T[d][b]||{};A._mergeAnnotation(c,s[d][b],T[d][b]);}}}},_mergeAnnotation:function(n,m,T){if(Array.isArray(m[n])){T[n]=m[n].slice(0);}else{T[n]=T[n]||{};for(var k in m[n]){T[n][k]=m[n][k];}}},parse:function(m,x,s){var b={},c,d,e,T,f,g,h,l,n,p,r,u,v,w,y,z,B,C,E,F,G,H,I,i,J;A._parserData={};A._oXPath=A.getXPath();A._parserData.metadataInstance=m;A._parserData.serviceMetadata=m.getServiceMetadata();A._parserData.xmlDocument=A._oXPath.setNameSpace(x);A._parserData.schema={};A._parserData.aliases={};A._parserData.url=s?s:"metadata document";c=A._oXPath.selectNodes("//d:Schema",A._parserData.xmlDocument);for(i=0;i<c.length;i+=1){d=A._oXPath.nextNode(c,i);A._parserData.schema.Alias=d.getAttribute("Alias");A._parserData.schema.Namespace=d.getAttribute("Namespace");}var K={};var L=A._parseReferences(K);if(L){b.annotationReferences=K;b.aliasDefinitions=A._parserData.aliases;}e=A._oXPath.selectNodes("//d:Term",A._parserData.xmlDocument);if(e.length>0){T={};for(J=0;J<e.length;J+=1){f=A._oXPath.nextNode(e,J);g=A.replaceWithAlias(f.getAttribute("Type"));T["@"+A._parserData.schema.Alias+"."+f.getAttribute("Name")]=g;}b.termDefinitions=T;}A._parserData.metadataProperties=A.getAllPropertiesMetadata(A._parserData.serviceMetadata);if(A._parserData.metadataProperties.extensions){b.propertyExtensions=A._parserData.metadataProperties.extensions;}h=A._oXPath.selectNodes("//d:Annotations ",A._parserData.xmlDocument);for(J=0;J<h.length;J+=1){l=A._oXPath.nextNode(h,J);if(l.hasChildNodes()===false){continue;}n=l.getAttribute("Target");p=n.split(".")[0];if(p&&A._parserData.aliases[p]){n=n.replace(new RegExp(p,""),A._parserData.aliases[p]);}r=n;u=null;var N=null;if(n.indexOf("/")>0){r=n.split("/")[0];var S=A._parserData.serviceMetadata.dataServices&&A._parserData.serviceMetadata.dataServices.schema&&A._parserData.serviceMetadata.dataServices.schema.length;if(S){for(var j=A._parserData.serviceMetadata.dataServices.schema.length-1;j>=0;j--){var O=A._parserData.serviceMetadata.dataServices.schema[j];if(O.entityContainer){var P=r.split('.');for(var k=O.entityContainer.length-1;k>=0;k--){if(O.entityContainer[k].name===P[P.length-1]){N=n.replace(r+"/","");break;}}}}}if(!N){u=n.replace(r+"/","");}}if(u){if(!b.propertyAnnotations){b.propertyAnnotations={};}if(!b.propertyAnnotations[r]){b.propertyAnnotations[r]={};}if(!b.propertyAnnotations[r][u]){b.propertyAnnotations[r][u]={};}v=A._oXPath.selectNodes("./d:Annotation",l);for(var Q=0;Q<v.length;Q+=1){w=A._oXPath.nextNode(v,Q);y=A.replaceWithAlias(w.getAttribute("Term"));var R=l.getAttribute("Qualifier")||w.getAttribute("Qualifier");if(R){y+="#"+R;}if(w.hasChildNodes()===false){var o={};A.enrichFromPropertyValueAttributes(o,w);if(q.isEmptyObject(o)){o.Bool="true";}b.propertyAnnotations[r][u][y]=o;}else{b.propertyAnnotations[r][u][y]=A.getPropertyValue(w);}}}else{var U;if(N){if(!b["EntityContainer"]){b["EntityContainer"]={};}if(!b["EntityContainer"][r]){b["EntityContainer"][r]={};}U=b["EntityContainer"][r];}else{if(!b[r]){b[r]={};}U=b[r];}z=r.replace(A._parserData.aliases[p],p);v=A._oXPath.selectNodes("./d:Annotation",l);for(var V=0;V<v.length;V+=1){w=A._oXPath.nextNode(v,V);var W=A._parseAnnotation(r,l,w);B=W.key;C=W.value;if(!N){U[B]=C;}else{if(!U[N]){U[N]={};}U[N][B]=C;}}E=A._oXPath.selectNodes("//d:Annotations[contains(@Target, '"+z+"')]//d:PropertyValue[contains(@Path, '/')]//@Path",A._parserData.xmlDocument);for(i=0;i<E.length;i+=1){F=A._oXPath.nextNode(E,i);G=F.value;if(b.propertyAnnotations){if(b.propertyAnnotations[r]){if(b.propertyAnnotations[r][G]){continue;}}}H=G.split('/');if(A.findNavProperty(r,H[0])){if(!b.expand){b.expand={};}if(!b.expand[r]){b.expand[r]={};}b.expand[r][H[0]]=H[0];}}I=A._oXPath.selectNodes("//d:Annotations[contains(@Target, '"+z+"')]//d:Path[contains(., '/')]",A._parserData.xmlDocument);for(i=0;i<I.length;i+=1){F=A._oXPath.nextNode(I,i);G=A._oXPath.getNodeText(F);if(b.propertyAnnotations&&b.propertyAnnotations[r]&&b.propertyAnnotations[r][G]){continue;}if(!b.expand){b.expand={};}if(!b.expand[r]){b.expand[r]={};}H=G.split('/');if(A.findNavProperty(r,H[0])){if(!b.expand){b.expand={};}if(!b.expand[r]){b.expand[r]={};}b.expand[r][H[0]]=H[0];}}}}delete A._parserData;return b;},_parseAnnotation:function(s,o,b){var Q=o.getAttribute("Qualifier")||b.getAttribute("Qualifier");var T=A.replaceWithAlias(b.getAttribute("Term"),A._parserData.aliases);if(Q){T+="#"+Q;}var v=A.getPropertyValue(b,A._parserData.aliases,s);v=A.setEdmTypes(v,A._parserData.metadataProperties.types,s,A._parserData.schema);return{key:T,value:v};},_parseReferences:function(m){var f=false;var n,i;var x=A._oXPath;var s="//edmx:Reference/edmx:Include[@Namespace and @Alias]";var o=x.selectNodes(s,A._parserData.xmlDocument);for(i=0;i<o.length;++i){f=true;n=x.nextNode(o,i);A._parserData.aliases[n.getAttribute("Alias")]=n.getAttribute("Namespace");}var r="//edmx:Reference[@Uri]/edmx:IncludeAnnotations[@TermNamespace]";var R=x.selectNodes(r,A._parserData.xmlDocument);for(i=0;i<R.length;++i){f=true;n=x.nextNode(R,i);var T=n.getAttribute("TermNamespace");var b=n.getAttribute("TargetNamespace");var c=n.parentNode.getAttribute("Uri");if(b){if(!m[b]){m[b]={};}m[b][T]=c;}else{m[T]=c;}}return f;},getAllPropertiesMetadata:function(o){var b={},P={},c={},d=false,n,e,C,E={},f={},g={},h=false,r,s,u,T,v,R={types:P};if(!o.dataServices.schema){return R;}for(var i=o.dataServices.schema.length-1;i>=0;i-=1){b=o.dataServices.schema[i];if(b.entityType){n=b.namespace;e=b.entityType;C=b.complexType;for(var j=0;j<e.length;j+=1){E=e[j];g={};f={};if(E.property){for(var k=0;k<E.property.length;k+=1){r=E.property[k];if(r.type.substring(0,n.length)===n){if(C){for(var l=0;l<C.length;l+=1){if(C[l].name===r.type.substring(n.length+1)){if(C[l].property){for(var m=0;m<C[l].property.length;m+=1){s=C[l].property[m];f[C[l].name+"/"+s.name]=s.type;}}}}}}else{u=r.name;T=r.type;if(r.extensions){for(var p=0;p<r.extensions.length;p+=1){v=r.extensions[p];if((v.name==="display-format")&&(v.value==="Date")){T="Edm.Date";}else{h=true;if(!g[u]){g[u]={};}if(v.namespace&&!g[u][v.namespace]){g[u][v.namespace]={};}g[u][v.namespace][v.name]=v.value;}}}f[u]=T;}}}if(!P[n+"."+E.name]){P[n+"."+E.name]={};}P[n+"."+E.name]=f;if(h){if(!c[n+"."+E.name]){d=true;}c[n+"."+E.name]={};c[n+"."+E.name]=g;}}}}if(d){R={types:P,extensions:c};}return R;},setEdmTypes:function(p,P,T,s){function b(c){var o,e='';if(p[c]){o=p[c];if(o.Value&&o.Value.Path){e=A.getEdmType(o.Value.Path,P,T,s);if(e){p[c].EdmType=e;}}else if(o.Path){e=A.getEdmType(o.Path,P,T,s);if(e){p[c].EdmType=e;}}else if(o.Facets){p[c].Facets=A.setEdmTypes(o.Facets,P,T,s);}else if(o.Data){p[c].Data=A.setEdmTypes(o.Data,P,T,s);}else if(c==="Data"){p.Data=A.setEdmTypes(o,P,T,s);}else if(o.Value&&o.Value.Apply){p[c].Value.Apply.Parameters=A.setEdmTypes(o.Value.Apply.Parameters,P,T,s);}else if(o.Value&&o.Type&&(o.Type==="Path")){e=A.getEdmType(o.Value,P,T,s);if(e){p[c].EdmType=e;}}}}if(Array.isArray(p)){for(var v=0;v<p.length;v+=1){b(v);}}else{for(var V in p){b(V);}}return p;},getEdmType:function(p,P,T,s){var i=p.indexOf("/");if(i>-1){var b=p.substr(0,i);var n=A.findNavProperty(T,b);if(n){var m=A._parserData.metadataInstance._getEntityTypeByNavPropertyObject(n);if(m){T=m.entityType;p=p.substr(i+1);}}}if((p.charAt(0)==="@")&&(p.indexOf(s.Alias)===1)){p=p.slice(s.Alias.length+2);}if(p.indexOf("/")>=0){if(P[p.slice(0,p.indexOf("/"))]){T=p.slice(0,p.indexOf("/"));p=p.slice(p.indexOf("/")+1);}}for(var c in P[T]){if(p===c){return P[T][c];}}},enrichFromPropertyValueAttributes:function(m,n){var I={"Property":true,"Qualifier":true,"Term":true,"xmlns":true};for(var i=0;i<n.attributes.length;i+=1){var N=n.attributes[i].name;if(!I[N]&&(N.indexOf("xmlns:")!==0)){var v=n.attributes[i].value;if(N==="EnumMember"&&v.indexOf(" ")>-1){var V=v.split(" ");m[N]=V.map(A.replaceWithAlias).join(" ");}else{m[N]=A.replaceWithAlias(v);}}}return m;},_getRecordValues:function(n){var N=[];var x=A._oXPath;for(var i=0;i<n.length;++i){var o=x.nextNode(n,i);var v=A.getPropertyValues(o);var T=o.getAttribute("Type");if(T){v["RecordType"]=A.replaceWithAlias(T);}N.push(v);}return N;},_getTextValues:function(n){var N=[];var x=A._oXPath;for(var i=0;i<n.length;i+=1){var o=x.nextNode(n,i);var v={};var T=x.getNodeText(o);v[o.nodeName]=A._parserData.aliases?A.replaceWithAlias(T):T;N.push(v);}return N;},_getTextValue:function(n){var x=A._oXPath;var v="";if(n.nodeName in a){v=A.replaceWithAlias(x.getNodeText(n));}else{v=x.getNodeText(n);}if(n.nodeName!=="String"){v=v.trim();}return v;},getPropertyValue:function(d,s){var i;var x=A._oXPath;var p=d.nodeName==="Collection"?[]:{};if(d.hasChildNodes()){var r=x.selectNodes("./d:Record",d);var R=A._getRecordValues(r);var c=x.selectNodes("./d:Collection/d:Record | ./d:Collection/d:If/d:Record",d);var C=A._getRecordValues(c);var P=R.concat(C);if(P.length>0){if(c.length===0&&r.length>0){p=P[0];}else{p=P;}}else{var o=x.selectNodes("./d:Collection/d:AnnotationPath | ./d:Collection/d:NavigationPropertyPath | ./d:Collection/d:PropertyPath",d);if(o.length>0){p=A._getTextValues(o);}else{var b=x.selectNodes("./d:*[not(local-name() = \"Annotation\")]",d);if(b.length>0){for(i=0;i<b.length;i++){var e=x.nextNode(b,i);var v;var n=e.nodeName;var f=e.parentNode.nodeName;if(n==="Apply"){v=A.getApplyFunctions(e);}else{v=A.getPropertyValue(e);}if(M[f]){if(!Array.isArray(p)){p=[];}var V={};V[n]=v;p.push(V);}else if(n==="Collection"){p=v;}else{if(p[n]){q.sap.log.warning("Annotation contained multiple "+n+" values. Only the last "+"one will be stored: "+x.getPath(e));}p[n]=v;}}A.enrichFromPropertyValueAttributes(p,d);}else if(d.nodeName in t){p=A._getTextValue(d);}else{A.enrichFromPropertyValueAttributes(p,d);}}}var N=x.selectNodes("./d:Annotation",d);if(N.length>0){for(i=0;i<N.length;i++){var g=x.nextNode(N,i);var m=A._parseAnnotation(s,d,g);p[m.key]=m.value;}}}else if(d.nodeName in t){p=A._getTextValue(d);}else if(d.nodeName.toLowerCase()==="null"){p=null;}else{A.enrichFromPropertyValueAttributes(p,d);}return p;},getPropertyValues:function(p){var P={},i;var x=A._oXPath;var o=x.selectNodes("./d:Annotation",p);var b=x.selectNodes("./d:PropertyValue",p);function g(p,w,N){var h,j=p;while(j.nodeName!=="Annotation"){j=j.parentNode;}h=j.parentNode;return(w+" '"+N+"' is defined twice; "+"Source = "+A._parserData.url+", Annotation Target = "+h.getAttribute("Target")+", Term = "+j.getAttribute("Term"));}if(o.length===0&&b.length===0){P=A.getPropertyValue(p);}else{for(i=0;i<o.length;i++){var c=x.nextNode(o,i);var T=A.replaceWithAlias(c.getAttribute("Term"));P[T]=A.getPropertyValue(c);}for(i=0;i<b.length;i++){var d=x.nextNode(b,i);var s=d.getAttribute("Property");P[s]=A.getPropertyValue(d);var e=x.selectNodes("./d:Apply",d);for(var n=0;n<e.length;n+=1){var f=x.nextNode(e,n);P[s]={};P[s]['Apply']=A.getApplyFunctions(f);}}}return P;},getApplyFunctions:function(b){var x=A._oXPath;var m={Name:b.getAttribute('Function'),Parameters:[]};var p=x.selectNodes("./d:*",b);for(var i=0;i<p.length;i+=1){var P=x.nextNode(p,i);var c={Type:P.nodeName};if(P.nodeName==="Apply"){c.Value=A.getApplyFunctions(P);}else if(P.nodeName==="LabeledElement"){c.Value=A.getPropertyValue(P);c.Name=c.Value.Name;delete c.Value.Name;}else if(M[P.nodeName]){c.Value=A.getPropertyValue(P);}else{c.Value=x.getNodeText(P);}m.Parameters.push(c);}return m;},findNavProperty:function(e,p){var m=A._parserData.serviceMetadata;for(var i=m.dataServices.schema.length-1;i>=0;i-=1){var o=m.dataServices.schema[i];if(o.entityType){var n=o.namespace+".";var E=o.entityType;for(var k=E.length-1;k>=0;k-=1){if(n+E[k].name===e&&E[k].navigationProperty){for(var j=0;j<E[k].navigationProperty.length;j+=1){if(E[k].navigationProperty[j].name===p){return E[k].navigationProperty[j];}}}}}}return null;},replaceWithAlias:function(v,r){if(r===undefined){r=1;}for(var s in A._parserData.aliases){if(v.indexOf(s+".")>=0&&v.indexOf("."+s+".")<0){v=v.replace(s+".",A._parserData.aliases[s]+".");r--;if(r===0){return v;}}}return v;},getXPath:function(){var x={};var p=A._parserData;if(D.browser.msie){x={setNameSpace:function(o){o.setProperty("SelectionNamespaces",'xmlns:edmx="http://docs.oasis-open.org/odata/ns/edmx" xmlns:d="http://docs.oasis-open.org/odata/ns/edm"');o.setProperty("SelectionLanguage","XPath");return o;},selectNodes:function(x,i){return i.selectNodes(x);},nextNode:function(n){return n.nextNode();},getNodeText:function(n){return n.text;}};}else{x={setNameSpace:function(o){return o;},nsResolver:function(b){var n={"edmx":"http://docs.oasis-open.org/odata/ns/edmx","d":"http://docs.oasis-open.org/odata/ns/edm"};return n[b]||null;},selectNodes:function(P,i){var b=p.xmlDocument.evaluate(P,i,this.nsResolver,7,null);b.length=b.snapshotLength;return b;},nextNode:function(n,i){return n.snapshotItem(i);},getNodeText:function(n){return n.textContent;}};}x.getPath=function(n){var P="";var I="getAttribute"in n?n.getAttribute("id"):"";var T=n.tagName?n.tagName:"";if(I){P='id("'+I+'")';}else if(n instanceof Document){P="/";}else if(T.toLowerCase()==="body"){P=T;}else if(n.parentNode){var b=1;for(var i=0;i<n.parentNode.childNodes.length;++i){if(n.parentNode.childNodes[i]===n){P=x.getPath(n.parentNode)+"/"+T+"["+b+"]";break;}else if(n.parentNode.childNodes[i].nodeType===1&&n.parentNode.childNodes[i].tagName===T){++b;}}}else{q.sap.log.error("Wrong Input node - cannot find XPath to it: "+T);}return P;};return x;}};return A;});
