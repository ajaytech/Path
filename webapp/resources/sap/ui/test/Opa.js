/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/Device','./_LogCollector','./_OpaLogger','./_ParameterValidator','sap/ui/thirdparty/URI'],function($,D,_,a,b,U){"use strict";var l=a.getLogger("sap.ui.test.Opa"),L=_.getInstance(),q=[],c={},t=-1,s,Q,i,d,v=new b({errorPrefix:"sap.ui.test.Opa#waitFor"});function e(C,p){if(window["sap-ui-debug"]){p.timeout=p.debugTimeout;}var r=new Date();u();function u(){L.getAndClearLog();var R=C();d=p._stack;if(R.error){Q.reject(p);return;}if(R.result){f();return;}var P=(new Date()-r)/1000;if(p.timeout===0||p.timeout>P){t=setTimeout(u,p.pollingInterval);return;}j("Opa timeout",p);if(p.error){try{p.error(p,R.arguments);}finally{Q.reject(p);}}else{Q.reject(p);}}}function f(){if(!q.length){if(Q){Q.resolve();}return true;}var p=q.shift();t=setTimeout(function(){e(p.callback,p.options);},O.config.executionDelay);}function g(w,N){var p=w.get();if(p){var r=q.splice(q.length-p,p);r.forEach(function(u){u.options._nestedIn=N;});q=r.concat(q);}}function h(E){var p=E.toString();if(E.stack){p+="\n"+E.stack;}var r="Exception thrown by the testcode:'"+p+"'";return r;}function j(E,p,r){var u=L.getAndClearLog();if(u){E+="\nThis is what Opa logged:\n"+u;}if(!r&&p._stack){E+=m(p);}if(p.errorMessage){p.errorMessage+="\n"+E;}else{p.errorMessage=E;}l.error(p.errorMessage,"Opa");}function k(p){p=(p||0)+2;if(D.browser.mozilla){p=p-1;}var E=new Error(),r=E.stack;if(!r){try{throw E();}catch(u){r=u.stack;}}if(!r){return"";}r=r.split("\n");r.splice(0,p);return r.join("\n");}function m(p){var r="\nCallstack:\n";if(p._stack){r+=p._stack;delete p._stack;}else{r+="Unknown";}if(p._nestedIn){r+=m(p._nestedIn);delete p._nestedIn;}return r;}var O=function(p){this.and=this;$.extend(this,p);};O.config={};O.extendConfig=function(p){["actions","assertions","arrangements"].forEach(function(A){if(!p[A]){return;}Object.keys(O.config[A]).forEach(function(K){if(!p[A][K]){p[A][K]=O.config[A][K];}});});O.config=$.extend(true,O.config,p,o);};O._parseParam=function(p){var V=parseInt(p,10);return(typeof V==='number'&&isNaN(V))?p:V;};O._extractOpaUriParams=function(){var p='opa';var P={};var u=new U().search(true);for(var r in u){if(r.indexOf(p)==0){P[r.substr(p.length,1).toLowerCase()+r.substr(p.length+1)]=this._parseParam(u[r]);}}return P;};var o=O._extractOpaUriParams();var n=0;var I=D.browser.safari&&!D.browser.phantomJS;if(D.browser.msie||D.browser.edge||I){n=50;}O.resetConfig=function(){O.config=$.extend({arrangements:new O(),actions:new O(),assertions:new O(),timeout:15,pollingInterval:400,debugTimeout:0,_stackDropCount:0,executionDelay:n},o);};O.getContext=function(){return c;};O.emptyQueue=function emptyQueue(){if(i){throw new Error("Opa is emptying its queue. Calling Opa.emptyQueue() is not supported at this time.");}i=true;s=null;Q=$.Deferred();f();return Q.promise().fail(function(p){q=[];if(s){var E=s.qunitTimeout?"QUnit timeout":"Queue was stopped manually";p._stack=s.qunitTimeout&&d||k(1);j(E,p);}}).always(function(){q=[];t=-1;Q=null;d=null;i=false;});};O.stopQueue=function stopQueue(){O._stopQueue();};O._stopQueue=function(p){q=[];if(!Q){l.warning("stopQueue was called before emptyQueue, queued tests have never been executed","Opa");}else{if(t!==-1){clearTimeout(t);}s=p||{};Q.reject(s);}};O.resetConfig();a.setLevel(O.config.logLevel);O.prototype={getContext:O.getContext,waitFor:function(p){var r=$.Deferred(),F=O._createFilteredConfig(O._aConfigValuesForWaitFor);p=$.extend({},F,p);this._validateWaitFor(p);p._stack=k(1+p._stackDropCount);delete p._stackDropCount;var u=$.extend({},this);r.promise(u);q.push({callback:function(){var C=true;if(p.check){try{C=p.check.apply(this,arguments);}catch(E){var w="Failure in Opa check function\n"+h(E);j(w,p,E.stack);r.reject(p);return{error:true,arguments:arguments};}}if(s){return{result:true,arguments:arguments};}if(!C){return{result:false,arguments:arguments};}if(p.success){var W=O._getWaitForCounter();try{p.success.apply(this,arguments);}catch(E){var w="Failure in Opa success function\n"+h(E);j(w,p,E.stack);r.reject(p);return{error:true,arguments:arguments};}finally{g(W,p);}}r.resolve();return{result:true,arguments:arguments};}.bind(this),options:p});return u;},extendConfig:O.extendConfig,emptyQueue:O.emptyQueue,_validateWaitFor:function(p){v.validate({validationInfo:O._validationInfo,inputToValidate:p});},_schedulePromiseOnFlow:function(p){var P=false;var r;p.done(function(){P=true;}).fail(function(w){r="Error while waiting for promise scheduled on flow"+(w?", details: "+w:"");});var u={viewName:null,controlType:null,id:null,searchOpenDialogs:false,autoWait:false};u.check=function(){if(r){throw new Error(r);}return P;};return this.waitFor(u);}};O._createFilteredOptions=function(A,S){var F={};A.forEach(function(K){var C=S[K];if(C===undefined){return;}F[K]=C;});return F;};O._createFilteredConfig=function(A){return O._createFilteredOptions(A,O.config);};O._getWaitForCounter=function(){var p=q.length;return{get:function(){var r=q.length-p;return Math.max(r,0);}};};O._aConfigValuesForWaitFor=["errorMessage","timeout","debugTimeout","pollingInterval","_stackDropCount"];O._validationInfo={error:"func",check:"func",success:"func",timeout:"numeric",debugTimeout:"numeric",pollingInterval:"numeric",_stackDropCount:"numeric",errorMessage:"string"};return O;},true);
