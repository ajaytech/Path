/*
 * ! UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/model/json/JSONModel","sap/ui/fl/Utils","sap/ui/fl/changeHandler/BaseTreeModifier","sap/ui/fl/Change","sap/ui/fl/changeHandler/Base"],function(q,J,U,B,C,a){"use strict";var V=J.extend("sap.ui.fl.variants.VariantModel",{constructor:function(d,f,c,o){this.pSequentialImportCompleted=Promise.resolve();J.apply(this,arguments);this.bObserve=o;this.oFlexController=f;this.oComponent=c;this.bStandardVariantExists=true;this.oVariantController=undefined;this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");if(f&&f._oChangePersistence){this.oVariantController=f._oChangePersistence._oVariantController;}if(d&&typeof d=="object"){Object.keys(d).forEach(function(k){d[k].modified=false;d[k].variants.forEach(function(v){if(!d[k].currentVariant&&(v.key===d[k].defaultVariant)){d[k].currentVariant=v.key;}v.toBeDeleted=false;v.originalTitle=v.title;});});this.setData(d);}}});V.prototype.updateCurrentVariant=function(v,n){return this._switchToVariant(v,n).then(function(){this.oData[v].currentVariant=n;this.refresh(true);}.bind(this));};V.prototype.getCurrentVariantReference=function(v){return this.oData[v].currentVariant;};V.prototype.getVariantManagementReference=function(v){var s="";var i=-1;Object.keys(this.oData).some(function(k){return this.oData[k].variants.some(function(o,b){if(o.key===v){s=k;i=b;return true;}});}.bind(this));return{variantManagementReference:s,variantIndex:i};};V.prototype.getVariant=function(v){var s=this.getVariantManagementReference(v).variantManagementReference;return this.oVariantController.getVariant(s,v);};V.prototype.getVariantProperty=function(v,p){return this.getVariant(v).content[p];};V.prototype._addChange=function(c){var v=c.getVariantReference();var s=this.getVariantManagementReference(v).variantManagementReference;return this.oVariantController.addChangeToVariant(c,s,v);};V.prototype._removeChange=function(c){var v=c.getVariantReference();var s=this.getVariantManagementReference(v).variantManagementReference;return this.oVariantController.removeChangeFromVariant(c,s,v);};V.prototype._duplicateVariant=function(p){var n=p.newVariantReference,s=p.sourceVariantReference,S=this.getVariant(s);var d={content:{},changes:JSON.parse(JSON.stringify(S.changes)),variantChanges:{setTitle:[]}};var c=U.isLayerAboveCurrentLayer(S.content.layer);Object.keys(S.content).forEach(function(k){if(k==="fileName"){d.content[k]=n;}else if(k==="variantReference"){if(c===0){d.content[k]=S.content["variantReference"];}else if(c===-1){d.content[k]=s;}}else if(k==="layer"){d.content[k]=p.layer;}else if(k==="title"){d.content[k]=S.content[k]+" Copy";}else{d.content[k]=S.content[k];}});var v=d.changes.slice();var D={};d.changes=v.reduce(function(b,o){if(U.isLayerAboveCurrentLayer(o.layer)===0){D=q.extend(true,{},o);D.fileName=U.createDefaultFileName(o.changeType);D.variantReference=d.content.fileName;if(!D.support){D.support={};}D.support.sourceChangeFileName=o.fileName;b.push(D);}return b;},[]);return d;};V.prototype._copyVariant=function(p){var d=this._duplicateVariant(p);var v=B.getSelector(p.variantManagementControl,p.appComponent).id;var o={author:p.layer,key:d.content.fileName,layer:p.layer,originalTitle:d.content.title,readOnly:false,title:d.content.title,toBeDeleted:false};var b=this.oFlexController.createVariant(d,this.oComponent);[b].concat(b.getChanges()).forEach(function(c){this.oFlexController._oChangePersistence.addDirtyChange(c);}.bind(this));var i=this.oVariantController.addVariantToVariantManagement(d,v);this.oData[v].variants.splice(i,0,o);return this.updateCurrentVariant(v,b.getId()).then(function(){this.checkUpdate();return b;}.bind(this));};V.prototype._removeVariant=function(v,s,b){var c=this.oFlexController._oChangePersistence.getDirtyChanges().filter(function(o){return(o.getVariantReference&&o.getVariantReference()===v.getId())||o.getId()===v.getId();});c.forEach(function(o){this.oFlexController._oChangePersistence.deleteChange(o);}.bind(this));var i=this.oVariantController.removeVariantFromVariantManagement(v,b);this.oData[b].variants.splice(i,1);return this.updateCurrentVariant(b,s).then(function(){this.checkUpdate();}.bind(this));};V.prototype._setVariantProperties=function(v,p,A){var i=this.getVariantManagementReference(p.variantReference).variantIndex;var d=this.getData();var n={title:p.title,layer:p.layer};var c=null;var o=d[v].variants[i];o.title=p.title;var s=this.oVariantController._setVariantData(n,v,i);d[v].variants.splice(i,1);d[v].variants.splice(s,0,o);if(A){n.changeType="setTitle";n.fileType="ctrl_variant_change";n.fileName=U.createDefaultFileName();n.variantReference=p.variantReference;a.setTextInChange(n,"title",p.title,"XFLD");o.modified=true;c=this.oFlexController.createBaseChange(n,p.appComponent);this.oFlexController._oChangePersistence.addDirtyChange(c);}else{this.oFlexController._oChangePersistence.deleteChange(p.change);}this.setData(d);return c;};V.prototype._switchToVariant=function(v,n){var c=this.oData[v].currentVariant;var m=this.oFlexController._oChangePersistence.loadSwitchChangesMapForComponent(v,c,n);var A=U.getAppComponentForControl(this.oComponent);return Promise.resolve().then(this.oFlexController.revertChangesOnControl.bind(this.oFlexController,m.aRevert,A)).then(this.oFlexController.applyVariantChanges.bind(this.oFlexController,m.aNew,this.oComponent));};V.prototype.ensureStandardEntryExists=function(v){var d=this.getData();if(!d[v]){this.bStandardVariantExists=false;d[v]={modified:false,currentVariant:v,defaultVariant:v,variants:[{key:v,originalTitle:this._oResourceBundle.getText("STANDARD_VARIANT_ORIGINAL_TITLE"),readOnly:true,title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),toBeDeleted:false}]};this.setData(d);if(this.oVariantController){var o={changes:{variantSection:{}}};o.changes.variantSection[v]={defaultVariant:v,variants:[{content:{fileName:v,title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),fileType:"ctrl_variant",variantManagementReference:v,variantReference:""},changes:[]}]};this.oVariantController._setChangeFileContent(o);}}};return V;},true);
