/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/support/Plugin","sap/ui/core/support/Support","sap/ui/model/json/JSONModel","sap/ui/fl/FlexController","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/Utils"],function(q,P,S,J,F,C,U){"use strict";var a=P.extend("sap.ui.fl.support.Flexibility",{constructor:function(s){P.apply(this,["sapUiSupportFlexibility","Flexibility",s]);this._oStub=s;if(this.runsAsToolPlugin()){this._aEventIds=[this.getId()+"SetApps",this.getId()+"SetChangesMaps"];}else{this._aEventIds=[this.getId()+"GetApps",this.getId()+"GetChangesMaps"];}}});a.prototype.sDelimiter=";";a.prototype.sNoDebug="noDebug";a.prototype.init=function(s){P.prototype.init.apply(this,arguments);var n="<div class='sapUiSmallMargin'>sapui5 has to be in <b>debug mode</b> or at least the "+"library \'<b> sap.ui.fl</b>\' has to be debugged.</div>"+"<div class='sapUiSmallMargin'>To set the debug sources use the URL parameter '<b>sap-ui-debug</b> "+"with general debug setting <b>sap-ui-debug=true</b> or to debug single libraries by naming the libraries "+"<b>sap-ui-debug=lib1, lib2, ...</b> (including '<b>sap.ui.fl</b>').</div>"+"<div class='sapUiSmallMargin'>Another option is to enable the debugging in this 'Diagnostics' window by "+"toggle the <b>Debug Sources</b> under the <b>Technical Info</b> panel.</div>";if(s.isToolStub()){this.addStylesheet("sap/ui/fl/support/flexibility");this.oChangesModel=new J();this.oAppModel=new J();this.oToolSettings=new J({hideDependingChanges:false,flInDebug:true,noDebugInfoText:n});this.oChangeDetails=new J();this._renderToolPlugin([]);S.getStub().sendEvent(this.getId()+"GetApps",{});}else{this.onsapUiSupportFlexibilityGetApps();}};a.prototype._renderToolPlugin=function(){var t=this;var _=function(){var r=sap.ui.getCore().createRenderManager();r.write("<div id='"+t.getId()+"-FlexCacheArea' class='sapUiSizeCompact' />");r.flush(t.$().get(0));r.destroy();};var b=function(){t.oView=sap.ui.view({viewName:"sap.ui.fl.support.diagnostics.Flexibility",type:sap.ui.core.mvc.ViewType.XML,viewData:{plugin:t}});t.oView.placeAt(t.getId()+"-FlexCacheArea");t.oView.setModel(t.oAppModel,"flexApps");t.oView.setModel(t.oToolSettings,"flexToolSettings");t.oView.setModel(t.oChangesModel,"flexChanges");t.oView.setModel(t.oChangeDetails,"flexChangeDetails");};_();b();};a.prototype._onAppSelected=function(A){S.getStub().sendEvent(this.getId()+"GetChangesMaps",{appKey:A});};a.prototype.onRefresh=function(){S.getStub().sendEvent(this.getId()+"GetApps",{});};a.prototype.onsapUiSupportFlexibilityGetApps=function(){if(U.isDebugEnabled()){var t=this;var A=[];if(C._instanceCache){q.each(C._instanceCache,function(r,i){Object.keys(i).forEach(function(v){A.push({key:r+t.sDelimiter+v,text:r,additionalText:v});});});}this._oStub.sendEvent(this.getId()+"SetApps",A);}else{this._oStub.sendEvent(this.getId()+"SetApps",this.sNoDebug);}};a.prototype.onsapUiSupportFlexibilityGetChangesMaps=function(e){var A=e.mParameters.appKey;var b=A.split(this.sDelimiter);var s=b[0];var c=b[1];this._getChangesMapForApp(s,c);};a.prototype.onsapUiSupportFlexibilitySetApps=function(e){var A=e.getParameters();var f=A!==this.sNoDebug;this.oToolSettings.setProperty("/flInDebug",f);if(f){this.oAppModel.setData(A);var o=this.oView.byId("appSelection");var b=o.getItems()[0];o.setSelectedItem(b);o.fireChange({selectedItem:b});}};a.prototype.onsapUiSupportFlexibilitySetChangesMaps=function(e){var c=e.getParameters();this.oChangesModel.setData(c);this.oView.byId("Tree").expandToLevel(1000);};a.prototype.exit=function(s){P.prototype.exit.apply(this,arguments);};a.prototype._getChangesMapForApp=function(A,s){function _(m,i){g[i]=[];var j=h[i];var k=sap.ui.getCore().byId(i);var l=[];var n=[];if(k){if(k.data(F.appliedChangesCustomDataKey)){l=k.data(F.appliedChangesCustomDataKey).split(",");}if(k.data(F.failedChangesCustomDataKey)){n=k.data(F.failedChangesCustomDataKey).split(",");}}g[i]=j.map(b.bind(this,k,l,n,m));}function b(i,j,k,m,l){var n={id:l.getId(),changeType:l.getChangeType(),selector:l.getSelector(),controlPresent:!!i,indexInAppliedChanges:undefined,indexOfFirstFailing:undefined,dependentControls:[],dependentChanges:[],someDirectDependingChangesFailed:false,someDirectDependingChangesNotApplied:false,isInSubTree:false};if(n.controlPresent&&j.indexOf(l.getId())>-1){n.indexInAppliedChanges=j.indexOf(l.getId());}if(n.controlPresent&&k.indexOf(l.getId())>-1){n.indexOfFirstFailing=k.indexOf(l.getId());}if(l._aDependentIdList){n.dependentControls=l._aDependentIdList.map(function(p){return{id:p,controlPresent:!!sap.ui.getCore().byId(p)};});}m[l.getId()]=n;return n;}function c(i,k,j){var l=j.dependencies;if(l.indexOf(i.id)!==-1){var n=JSON.stringify(m[k].selector)===JSON.stringify(i.selector);i.isInSubTree=i.isInSubTree||n;}}function d(i,j){j.forEach(function(k){q.each(D,c.bind(this,k));k.allDependendingControlsPresent=k.dependentControls.every(function(l){return l.controlPresent;});if(D[k.id]&&D[k.id].dependencies){D[k.id].dependencies.forEach(function(l){var n=m[l];var p=n.indexInAppliedChanges==undefined;var n=m[l];k.someDirectDependingChangesNotApplied=k.someDirectDependingChangesNotApplied||p;var r=n.indexOfFirstFailing==undefined;var u=r&&p;k.someDirectDependingChangesFailed=k.someDirectDependingChangesFailed||r;k.someDirectDependingChangesNotSuccessfulApplied=k.someDirectDependingChangesNotSuccessfulApplied||u;k.dependentChanges.push(n);});}k.isApplicable=!k.someDirectDependingChangesNotApplied&&k.controlPresent&&k.allDependendingControlsPresent&&!k.someDirectDependingChangesNotApplied;k.isPossibleRootCause=k.isApplicable&&k.indexInAppliedChanges==undefined;});}function e(i){i=i.filter(function(j){return!i.some(function(k){return k.dependentChanges.some(function(l){return l.id==j.id;});});});return i.map(function(j){return{id:j.id,text:j.changeType,nodes:j.dependentChanges?e(j.dependentChanges):[]};});}function f(i,j){t.push({text:i,nodes:e(j)});}var m={};var g={};var t=[];var o=C.getChangePersistenceForComponent(A,s);var h=o._mChanges.mChanges;var D=o._mChangesInitial.mDependencies;Object.keys(h).forEach(_.bind(this,m));q.each(g,d);q.each(g,f);this._oStub.sendEvent(this.getId()+"SetChangesMaps",{changes:m,tree:t});};return a;});
