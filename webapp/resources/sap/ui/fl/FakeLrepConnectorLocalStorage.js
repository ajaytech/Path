/*
 * ! UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/FakeLrepLocalStorage","sap/ui/fl/FakeLrepConnector","sap/ui/fl/LrepConnector","sap/ui/fl/Cache","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/Utils"],function(F,a,L,C,b,U){"use strict";c._oBackendInstances={};function c(s){this.mSettings=jQuery.extend({"isKeyUser":true,"isAtoAvailable":false,"isProductiveSystem":false},s);}jQuery.extend(c.prototype,a.prototype);c.prototype.create=function(v){var r;if(Array.isArray(v)){r=v.map(function(m){return this._saveChange(m);}.bind(this));}else{r=this._saveChange(v);}return Promise.resolve({response:r,status:'success'});};c.prototype._saveChange=function(m){if(!m.creation){m.creation=new Date().toISOString();}F.saveChange(m.fileName,m);return m;};c.prototype.update=function(m,s,d,i){return Promise.resolve({response:this._saveChange(m),status:'success'});};c.prototype.deleteChange=function(o){F.deleteChange(o.sChangeName);return Promise.resolve({response:undefined,status:"nocontent"});};c.prototype.deleteChanges=function(){F.deleteChanges();return Promise.resolve({response:undefined,status:"nocontent"});};c.prototype.loadChanges=function(s){var d=F.getChanges();return new Promise(function(r,e){var R={};if(this.mSettings.sInitialComponentJsonPath){jQuery.getJSON(this.mSettings.sInitialComponentJsonPath).done(function(o){R={changes:o,componentClassName:s};r(R);}).fail(function(f){e(f);});}else{r(R);}}.bind(this)).then(function(r){var v=[];var e=[];var f=[];d.forEach(function(o){if(o.fileType==="ctrl_variant"&&o.variantManagementReference){v.push(o);}else if(o.fileType==="ctrl_variant_change"){e.push(o);}else{f.push(o);}});r=this._createChangesMap(r,v);r=this._sortChanges(r,f,e);r=this._assignVariantReferenceChanges(r);r.changes.contexts=[];r.changes.settings=this.mSettings;r.componentClassName=s;return r;}.bind(this));};c.prototype._createChangesMap=function(r,v){if(!r||!r.changes){r={changes:{}};}if(!r.changes.changes){r.changes.changes=[];}if(!r.changes.variantSection){r.changes.variantSection={};}var f=function(e,n){return e.some(function(o){return o.content.fileName===n.fileName;});};var V={};v.forEach(function(o){V=r.changes.variantSection[o.variantManagementReference];if(!V){V={variants:[{content:o,changes:[],variantChanges:{setTitle:[]}}],defaultVariant:o.fileName};r.changes.variantSection[o.variantManagementReference]=V;}else{if(!f(V.variants,o)){V.variants.push({content:o,changes:[],variantChanges:{setTitle:[]}});}}});return r;};c.prototype._assignVariantReferenceChanges=function(r){Object.keys(r.changes.variantSection).forEach(function(v){var V=r.changes.variantSection[v].variants;V.forEach(function(o){var s=o.content.variantReference;var e=o.changes;if(s){e=this._getReferencedChanges(r,o).concat(e);}o.changes=e;}.bind(this));}.bind(this));return r;};c.prototype._getReferencedChanges=function(r,o){var R=[];r.changes.variantSection[o.content.variantManagementReference].variants.some(function(v){if(o.content.variantReference===v.content.fileName){R=v.changes.filter(function(d){return U.isLayerAboveCurrentLayer(d.layer)===-1;});if(v.content.variantReference){R=R.concat(this._getReferencedChanges(r,v));}return true;}}.bind(this));return R;};c.prototype._sortChanges=function(r,d,e){var A=function(r,v,o){r.changes.variantSection[v].variants.some(function(V){if(V.content.fileName===o.variantReference){V.changes.push(o);return true;}});};var f=function(r,v,V){r.changes.variantSection[v].variants.some(function(o){if(o.content.fileName===V.variantReference){o.variantChanges[V.changeType].push(V);return true;}});};d.forEach(function(o){if(!o.variantReference){r.changes.changes.push(o);}else{Object.keys(r.changes.variantSection).forEach(function(v){A(r,v,o);});}});e.forEach(function(v){Object.keys(r.changes.variantSection).forEach(function(V){f(r,V,v);});});return r;};c.prototype.loadSettings=function(){return new Promise(function(r,d){var s={};r(s);});};c.enableFakeConnector=function(s,A,d){s=s||{};function r(){c.enableFakeConnector.original=L.createConnector;L.createConnector=function(){if(!c._oFakeInstance){c._oFakeInstance=new c(s);}return c._oFakeInstance;};}if(A&&d){var o=b.getChangePersistenceForComponent(A,d);if(!(o._oConnector instanceof c)){C.clearEntry(A,d);if(!c._oBackendInstances[A]){c._oBackendInstances[A]={};}c._oBackendInstances[A][d]=o._oConnector;o._oConnector=new c(s);}r();return;}C.clearEntries();if(c.enableFakeConnector.original){return;}r();};c.disableFakeConnector=function(A,s){function r(){if(c.enableFakeConnector.original){L.createConnector=c.enableFakeConnector.original;c.enableFakeConnector.original=undefined;c._oFakeInstance=undefined;}}if(A&&s){var o=b.getChangePersistenceForComponent(A,s);if(!(o._oConnector instanceof L)){C.clearEntry(A,s);if(c._oBackendInstances[A]&&c._oBackendInstances[A][s]){o._oConnector=c._oBackendInstances[A][s];c._oBackendInstances[A][s]=undefined;}}r();return;}C.clearEntries();r();};return c;},true);
