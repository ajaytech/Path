/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/rta/plugin/Plugin",'sap/ui/dt/ElementUtil','sap/ui/dt/OverlayRegistry','sap/ui/rta/Utils','sap/ui/fl/Utils','sap/ui/core/StashedControlSupport','sap/ui/dt/ElementDesignTimeMetadata'],function(q,P,E,O,U,F,S,a){"use strict";function _(s,o){var p,r=o.getRelevantContainer(!s),R=O.getOverlay(r);if(s){p=o.getParentElementOverlay();}else{p=o;}return{relevantContainerOverlay:R,parentOverlay:p,relevantContainer:r,parent:p.getElementInstance()};}function b(p,C){return C.sParentAggregationName;}function c(p,s){var o=p.getElementInstance();var i=E.getAggregation(o,s).filter(function(C){var m=O.getOverlay(C);if(!this.hasStableId(m)){return false;}var r=p.getRelevantContainer(true);var R=O.getOverlay(r);var n=p;var t=false;do{t=!n.getElementVisibility();if(t){break;}if(n===R){break;}else{n=n.getParentElementOverlay();}}while(n);if(t){return true;}return m.getElementVisibility()===false;},this);var l=S.getStashedControls(o.getId());return i.concat(l);}var d=true,e=false;function f(r,m,p,s,C){var n=[];var i;var l;if(m.addODataProperty){var o=m.aggregation;var D=m.addODataProperty.designTimeMetadata;i=D.getAggregationDescription(o,p);if(i){l=s?i.singular:i.plural;n.push(l);}}if(m.reveal){Object.keys(m.reveal.types).forEach(function(T){var u=m.reveal.types[T];i=u.designTimeMetadata.getName(p);if(i){l=s?i.singular:i.plural;n.push(l);}});}var N=n.reduce(function(u,v){if(u.indexOf(v)===-1){u.push(v);}return u;},[]);var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");if(N.length===1){l=N[0];}else if(C){l=C;}else{l=t.getText("MULTIPLE_CONTROL_NAME");}return t.getText(r,l);}function g(){return{designTimeMetadata:new a({data:{name:{singular:function(){return sap.uxap.i18nModel.getResourceBundle().getText("SECTION_CONTROL_NAME");},plural:function(){return sap.uxap.i18nModel.getResourceBundle().getText("SECTION_CONTROL_NAME_PLURAL");}},actions:{reveal:{changeType:"unstashControl",getAggregationName:b}}}}),action:{changeType:"unstashControl",getAggregationName:b}};}var A=P.extend("sap.ui.rta.plugin.additionalElements.AdditionalElementsPlugin",{metadata:{library:"sap.ui.rta",properties:{analyzer:"object",dialog:"object",commandFactory:"object"},associations:{},events:{}},getContextMenuTitle:function(o,i){var p=_(o,i);var m=this._getActions(o,i);return f("CTX_ADD_ELEMENTS",m,p.parent,d);},isAvailable:function(o,i){return this._isEditableByPlugin(i,o);},isEnabled:function(o,i){var p;var I;if(o){p=i.getParentElementOverlay();if(p&&this.hasStableId(p)){I=true;}else{I=false;}}else{var m=this._getActions(o,i);if(m.reveal&&m.reveal.elements.length===0&&!m.addODataProperty){I=false;}else{I=true;}}return I&&this.isMultiSelectionInactive.call(this,i);},_getRevealActions:function(s,o){var p=_(s,o);var r=this._getTypes(r,p,s,o);return r;},_getTypes:function(r,p,s,o){var i=[p.parentOverlay];var R=o.getRelevantContainer(!s);if(R!==p.parent){i=E.findAllSiblingsInContainer(p.parent,R).map(function(m){return O.getOverlay(m);});}var l;if(s){l=[o.getParentAggregationOverlay().getAggregationName()];}else{l=p.parentOverlay.getAggregationOverlays().filter(function(m){return!m.getDesignTimeMetadata().isIgnored(p.parent);}).map(function(m){return m.getAggregationName();});}r=l.reduce(this._getRevealActionFromAggregations.bind(this,i),{});return r;},_getRevealActionFromAggregations:function(p,i,s){var I=p.reduce(function(l,o){return o?l.concat(c.call(this,o,s)):l;}.bind(this),[]);var C=function(t,o){var T=o.getMetadata().getName();if(!t[T]){if(T==="sap.ui.core._StashedControl"){t[T]=g();}else{var l=O.getOverlay(o);if(l){var D=l.getDesignTimeMetadata();var r=D&&D.getAction("reveal",o);if(r&&r.changeType){if(r.changeOnRelevantContainer){o=l.getRelevantContainer();}if(this.hasChangeHandler(r.changeType,o)){if(!r.getAggregationName){r.getAggregationName=b;}t[T]={designTimeMetadata:D,action:r};}}}}}return t;};var t=I.reduce(C.bind(this),{});I=I.filter(function(o){return!!t[o.getMetadata().getName()];});if(I.length>0&&Object.keys(t).length>0){i[s]={reveal:{elements:I,types:t}};}return i;},_getAddODataPropertyActions:function(s,o){var p=_(s,o);var D=p.parentOverlay.getDesignTimeMetadata();var i=D.getAggregationAction("addODataProperty",p.parent);var C=p.parent;var l=function(m,n){if(n){if(n.changeOnRelevantContainer){C=p.relevantContainer;}if(n.changeType&&this.hasChangeHandler(n.changeType,C)){m[n.aggregation]={addODataProperty:{designTimeMetadata:D,action:n}};}return m;}};if(i&&i.length>0){return i.reduce(l.bind(this),{});}},_getActions:function(s,o){var r=this._getRevealActions(s,o);var m=this._getAddODataPropertyActions(s,o);var i=q.extend(true,r,m);var l=Object.keys(i);if(l.length===0){return{};}else if(l.length>1){q.sap.log.error("reveal or addODataProperty action defined for more than 1 aggregation, that is not yet possible");}var n=l[0];i[n].aggregation=n;return i[n];},_hasRevealActionsOnChildren:function(o){var r=this._getRevealActions(false,o);return!!r&&Object.keys(r).length>0;},showAvailableElements:function(o,i,I,C){var l=i[0];var p=_(o,l);var s=o&&l.getElementInstance();var m=[];var n=this._getActions(o,l);if(n.reveal){m.push(this.getAnalyzer().enhanceInvisibleElements(p.parent,n));}if(n.addODataProperty){n.addODataProperty.relevantContainer=l.getRelevantContainer(!o);m.push(this.getAnalyzer().getUnboundODataProperties(p.parent,n.addODataProperty));}if(n.aggregation||C){this._setDialogTitle(n,p.parent,C);}return Promise.resolve().then(function(){if(n.addODataProperty){return U.isServiceUpToDate(p.parent);}}).then(function(){if(n.addODataProperty){this.getDialog()._oCustomFieldButton.setVisible(true);return U.isCustomFieldAvailable(p.parent);}else{this.getDialog()._oCustomFieldButton.setVisible(false);}}.bind(this)).then(function(r){if(r){this._oCurrentFieldExtInfo=r;this.getDialog().setCustomFieldEnabled(true);this.getDialog().detachEvent('openCustomField',this._onOpenCustomField,this);this.getDialog().attachEvent('openCustomField',null,this._onOpenCustomField,this);}}.bind(this)).then(h.bind(null,m)).then(function(r){this.getDialog().setElements(r);return this.getDialog().open().then(function(){this._createCommands(o,l,p,s,n.designTimeMetadata,n,I);}.bind(this)).catch(function(t){if(t instanceof Error){throw t;}});}.bind(this)).catch(function(r){if(r instanceof Error){throw r;}else{q.sap.log.info("Service not up to date, skipping add dialog","sap.ui.rta");}});},_setDialogTitle:function(m,p,C){var D=f("HEADER_ADDITIONAL_ELEMENTS",m,p,e,C);this.getDialog().setTitle(D);if(C){this.getDialog()._oList.setNoDataText(this.getDialog()._oTextResources.getText("MSG_NO_FIELDS",C.toLowerCase()));}},_onOpenCustomField:function(o){var C=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var H=(C&&C.hrefForExternal({target:{semanticObject:"CustomField",action:"develop"},params:{businessContexts:this._oCurrentFieldExtInfo.BusinessContexts,serviceName:this._oCurrentFieldExtInfo.ServiceName,serviceVersion:this._oCurrentFieldExtInfo.ServiceVersion,entityType:this._oCurrentFieldExtInfo.EntityType}}));U.openNewWindow(H);},_createCommands:function(s,o,p,i,D,m,I){var l=this.getDialog().getSelectedElements();if(l.length>0){var C=this.getCommandFactory().getCommandFor(p.parent,"composite");l.forEach(function(n){var r;switch(n.type){case"invisible":r=this._createRevealCommandForInvisible(n,m,p,i);C.addCommand(r);r=this._createMoveCommandForInvisible(n,m,p,i,I);if(r){C.addCommand(r);}else{q.sap.log.warning("No move action configured for "+p.parent.getMetadata().getName()+", aggregation: "+m.aggregation,"sap.ui.rta");}break;case"odata":var t=p.parentOverlay.getAggregationOverlay(m.aggregation);var u=t.getDesignTimeMetadata();var v=u.getAction("addODataProperty",p.parent);var w=v.changeHandlerSettings;var R;if(w&&w.content){R=w.content.requiredLibraries;}if(R){var x=this._createCommandForAddLibrary(p,m,R,u);C.addCommand(x);}r=this._createCommandsForOData(n,m,p,i,I);C.addCommand(r);break;default:q.sap.log.error("Can't create command for untreated element.type "+n.type);}},this);this.fireElementModified({"command":C});}},_createCommandsForOData:function(s,m,p,o,i){var l=p.parentOverlay.getAggregationOverlay(m.aggregation);var n=l.getDesignTimeMetadata();var r=n.getAction("addODataProperty",p.parent);var C=r.changeHandlerSettings;var t;if(C&&C.key){t=C.key.oDataServiceVersion;}var R=p.parent;if(r.changeOnRelevantContainer){R=p.relevantContainer;}var u=U.getIndex(p.parent,o,m.aggregation,n.getData().getIndex);var v=this._getChangeHandlerForControlType(p.parent.getMetadata().getName(),r.changeType);var V;if(p.parentOverlay.getVariantManagement&&v&&v.revertChange){V=p.parentOverlay.getVariantManagement();}return this.getCommandFactory().getCommandFor(p.parent,"addODataProperty",{newControlId:U.createFieldLabelId(R,s.entityType,s.bindingPath),index:i!==undefined?i:u,bindingString:s.bindingPath,entityType:s.entityType,parentId:p.parent.getId(),oDataServiceVersion:t},n,V);},_createCommandForAddLibrary:function(p,m,r,o){var C=F.getAppComponentForControl(p.relevantContainer);var M=C.getManifest();var R=M["sap.app"].id;return this.getCommandFactory().getCommandFor(p.publicParent,"addLibrary",{reference:R,parameters:{libraries:r},appComponent:C},o);},_createRevealCommandForInvisible:function(s,m,p,o){var r=s.element;var R=O.getOverlay(r);var t=r.getMetadata().getName();var T=m.reveal.types[t];var D=T.designTimeMetadata;var i=D.getAction("reveal",r);var l=O.getOverlay(r);if(!l){var n=j(r,p,R);l=O.getOverlay(n);}var v;if(l){v=this.getVariantManagementReference(l,i,false,r);}if(i.changeOnRelevantContainer){return this.getCommandFactory().getCommandFor(r,"reveal",{revealedElementId:r.getId(),directParent:p.parent},D,v);}else{return this.getCommandFactory().getCommandFor(r,"reveal",{},D,v);}},_createMoveCommandForInvisible:function(s,m,p,o,i){var r=s.element;var R=O.getOverlay(r);var t=r.getMetadata().getName();var l;if(R){l=R.getParentAggregationOverlay().getAggregationName();}else{var T=m.reveal.types[t];l=T.action.getAggregationName(p.parent,r);}var n=j(r,p,R);var u=p.parent;var v=U.getIndex(p.parent,o,l);var w=U.getIndex(n,r,l)-1;v=i!==undefined?i:k(n,u,w,v);var C;if(v!==w||p.parent!==r.getParent()){var x=O.getOverlay(r)?O.getOverlay(r).getParentAggregationOverlay():p.relevantContainerOverlay;var y=x.getDesignTimeMetadata();var M=y.getAction("move",r);var V;if(M){V=this.getVariantManagementReference(O.getOverlay(r),M,true);}C=this.getCommandFactory().getCommandFor(p.relevantContainer,"move",{movedElements:[{element:r,sourceIndex:w,targetIndex:v}],source:{publicParent:p.relevantContainer,parent:n,aggregation:l},target:{publicParent:p.relevantContainer,parent:u,aggregation:l}},y,V);}return C;},_isEditable:function(o){return{asSibling:this._isEditableCheck.call(this,o,true),asChild:this._isEditableCheck.call(this,o,false)};},_isEditableCheck:function(o,i){var l=false;var r=U.getRelevantContainerDesigntimeMetadata(o);if(!r){return false;}var m=this._getActions(i,o);var p=_(i,o);if(m.addODataProperty){var n=m.addODataProperty.action;l=n&&n.aggregation===o.getParentAggregationOverlay().getAggregationName();}if(!l&&m.reveal){l=true;}if(!l&&!i){l=this._hasRevealActionsOnChildren(o)||this.checkAggregationsOnSelf(p.parentOverlay,"addODataProperty");}if(l){return this.hasStableId(o);}else{return false;}},getMenuItems:function(o){var l=true;var p="CTX_ADD_ELEMENTS_AS_SIBLING";var r=20;var m=[];for(var i=0;i<2;i++){if(this.isAvailable(l,o)){var M=this.getContextMenuTitle.bind(this,l);m.push({id:p,text:M,handler:function(l,n){return this.showAvailableElements(l,n);}.bind(this,l),enabled:this.isEnabled.bind(this,l),rank:r});}l=false;p="CTX_ADD_ELEMENTS_AS_CHILD";r=30;}return m;}});function h(p){return Promise.all(p).then(function(i){var l=i[0]||[];if(l&&i[1]){l=l.concat(i[1]);}return l;});}function j(r,p,R){var o;if(R){o=R.getParentElementOverlay().getElementInstance();}if(!o&&r.sParentId){o=sap.ui.getCore().byId(r.sParentId);}else if(!o){o=p.parent;}return o;}function k(s,t,i,T){if(s===t&&i<T&&i>-1){return T-1;}return T;}return A;});
