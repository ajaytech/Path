/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/rta/plugin/Plugin','sap/ui/dt/Overlay','sap/ui/dt/ElementUtil','sap/ui/dt/OverlayUtil','sap/ui/dt/OverlayRegistry','sap/ui/rta/Utils','sap/ui/dt/DOMUtil'],function(q,P,O,E,a,b,U,D){"use strict";var R={_manageClickEvent:function(e){var o=e.getSource?e.getSource():e;if(o.isSelected()&&this.isRenameAvailable(o)){o.attachBrowserEvent("click",R._onClick,this);}else{o.detachBrowserEvent("click",R._onClick,this);}},startEdit:function(o,d,p){this._oEditedOverlay=o;var e=o.getElementInstance();var c=this._oEditedOverlay.getDesignTimeMetadata();var f=c.getAssociatedDomRef(e,d);if(!U.isElementInViewport(f)){f.get(0).scrollIntoView();}this._$oEditableControlDomRef=q(f);var g=sap.ui.dt.OverlayRegistry.getOverlay(f.id)||o;var w=q("<div class='sapUiRtaEditableField'></div>").appendTo(g.$());this._$editableField=q("<div contentEditable='true'></div>").appendTo(w);if(this._$oEditableControlDomRef.text()===""){this._$oEditableControlDomRef.text("_?_");this._$editableField.text("");}else{this._$editableField.text(this._$oEditableControlDomRef.text());}D.copyComputedStyle(this._$oEditableControlDomRef,this._$editableField);this._$editableField.children().remove();this._$editableField.css('visibility','hidden');this._$editableField.css({"-moz-user-modify":"read-write","-webkit-user-modify":"read-write","-ms-user-modify":"read-write","user-modify":"read-write","text-overflow":"clip"});O.getMutationObserver().ignoreOnce({target:this._$oEditableControlDomRef.get(0)});this._$editableField.one("focus",R._onEditableFieldFocus.bind(this));this._$editableField.on("blur",R._onEditableFieldBlur.bind(this));this._$editableField.on("keydown",R._onEditableFieldKeydown.bind(this));this._$editableField.on("dragstart",R._stopPropagation.bind(this));this._$editableField.on("drag",R._stopPropagation.bind(this));this._$editableField.on("dragend",R._stopPropagation.bind(this));this._$editableField.on("click",R._stopPropagation.bind(this));this._$editableField.on("mousedown",R._stopPropagation.bind(this));this.setOldValue(R._getCurrentEditableFieldText.call(this));setTimeout(function(){this._$oEditableControlDomRef.css("visibility","hidden");this._$editableField.offset({left:this._$oEditableControlDomRef.offset().left});this._$editableField.offset({top:this._$oEditableControlDomRef.offset().top});this._$editableField.css('visibility','');this._$editableField.focus();o.setSelected(true);sap.ui.getCore().getEventBus().publish('sap.ui.rta',p,{overlay:o,editableField:this._$editableField});}.bind(this),0);},_setDesignTime:function(d){this._aSelection=[];var o=this.getDesignTime();if(o){o.detachSelectionChange(R._onDesignTimeSelectionChange,this);}P.prototype.setDesignTime.apply(this,arguments);if(d){d.attachSelectionChange(R._onDesignTimeSelectionChange,this);this._aSelection=d.getSelection();}},_onDesignTimeSelectionChange:function(e){var s=e.getParameter("selection");this._aSelection.forEach(R._manageClickEvent,this);s.forEach(R._manageClickEvent,this);this._aSelection=s;},_stopPropagation:function(e){e.stopPropagation();},_onEditableFieldFocus:function(e){this._oEditedOverlay.setSelected(false);var c=e.target;var r=document.createRange();r.selectNodeContents(c);var s=window.getSelection();s.removeAllRanges();s.addRange(r);},_stopEdit:function(r,p){if(this._$oEditableControlDomRef.text()==="_?_"){this._$oEditableControlDomRef.text("");}this._oEditedOverlay.$().find(".sapUiRtaEditableField").remove();O.getMutationObserver().ignoreOnce({target:this._$oEditableControlDomRef.get(0)});this._$oEditableControlDomRef.css("visibility","visible");if(r){var o=this._oEditedOverlay;this._iStopTimeout=setTimeout(function(){o.setSelected(true);o.focus();sap.ui.getCore().getEventBus().publish('sap.ui.rta',p,{overlay:o});},500);}this._oEditedOverlay.setSelected(false);delete this._$editableField;delete this._$oEditableControlDomRef;delete this._oEditedOverlay;},_onEditableFieldBlur:function(e){this._emitLabelChangeEvent();this.stopEdit(false);},_onEditableFieldKeydown:function(e){switch(e.keyCode){case q.sap.KeyCodes.ENTER:this._emitLabelChangeEvent();this.stopEdit(true);e.preventDefault();break;case q.sap.KeyCodes.ESCAPE:this.stopEdit(true);e.preventDefault();break;case q.sap.KeyCodes.DELETE:e.stopPropagation();break;default:}},_getCurrentEditableFieldText:function(){var t=this._$editableField.text();if(t===""){t='\xa0';}return t;},_onClick:function(e){var o=sap.ui.getCore().byId(e.currentTarget.id);if(this.isRenameEnabled(o)&&!e.metaKey&&!e.ctrlKey){this.startEdit(o);e.preventDefault();}},_exit:function(){if(this._$oEditableControlDomRef){this.stopEdit(false);}clearTimeout(this._iStopTimeout);}};return R;},true);
